<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="author" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div id="imprimir" style="max-width: 300px;font-size: 50px; font-family: Arial, Helvetica, sans-serif;">
        <p style="margin-top: 0px;">Hello world!</p>
        <strong>Hello</strong>
        <strong>Hello</strong>
        <strong>Hello</strong>
        <strong>Hello</strong>
        <strong>Hello</strong>
        <strong>Hello</strong>
        <p>Hello world!</p>

        <image src="hello_kitty.jpg" width="150" height="150"></image>
    </div>

    <button onclick="teste()">Imprimir</button>
    <button onclick="download()">download</button>

    <script src="node_modules/qz-tray/qz-tray.js"></script>
    <script src="node_modules/html-to-image/dist/html-to-image.js"></script>
    <script src="cptable.js"></script>
    <script src="cputils.js"></script>
    <script src="JSESCPOSBuilder.js"></script>
    <!-- <script src="js/script.js"></script> -->

    <script>
        async function download() {
            let canvas = await gerar_canvas();
            canvas = make_bw_buffer(canvas);

            let img = new Image();
            img.src = canvas.toDataURL();

            document.body.appendChild(img);
        }

        function dec_2_hex( num ) {
            let hex = num.toString(16);

            if(hex.length < 2)
                hex = '0' + hex;

            return eval('"\\x' + hex + '"');
        }

        async function teste(){
            await qz.websocket.connect();

            let canvas = await gerar_canvas();
            canvas = make_bw_buffer(canvas);

            let command = (new Neodynamic.JSESCPOSBuilder.Document())
                        .image(canvas)
                        .generateArray()
                        .map((d) => dec_2_hex(d) );

            imprimir(command);
        }

        function imprimir(command){
            var config = qz.configs.create("MP-4200 TH", {encoding: 'ISO-8859-1'});

            command.unshift('\x1B\x40');
            command.push('\x0A\x0A\x0A\x0A\x0A\x0A');
            command.push('\x1D\x56\x00');

            qz.print(config, command);
        }

        function gerar_img(){
            let imprimir = document.getElementById('imprimir');

            return htmlToImage.toPng(imprimir, {
                quality: 0.10,
                width: 484,
                height: imprimir.clientHeight
            });
        }

        async function gerar_canvas(){
            let imprimir = document.getElementById('imprimir');

            return await htmlToImage.toCanvas(imprimir, {
                quality: 0.10,
                width: 484,
                height: imprimir.clientHeight
            });

            // let ctx = canvas.getContext("2d");

            // ctx.width = canvas.width;
            // ctx.height = canvas.height;

            // return ctx;
        }

        function make_bw_buffer(canvas){
            const threshold = 210;

            let ctx = canvas.getContext("2d");

            let idata = ctx.getImageData(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < idata.data.length; i += 4) {
                luma = idata.data[i] * 0.3 + idata.data[i + 1] * 0.59 + idata.data[i + 2] * 0.11;
                luma = luma < threshold ? 0 : 255;

                idata.data[i] = luma;
                idata.data[i + 1] = luma;
                idata.data[i + 2] = luma;
            }

            ctx.putImageData(idata, 0, 0);

            return canvas;
        }
    </script>
</body>

</html>